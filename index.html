<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Radiation Track Viewer</title>

  <!-- Leaflet core -->
  <link href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" integrity="sha256-uNxTzFfGcqPVp8BpCiTRzJQ6r5d4n2wk8H686Dg9W38=" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o2b8r8m+UsfvtVX1Y5CFja40tH8WJzoFjCvqgK+Y1wA=" crossorigin="anonymous"></script>
  <!-- Leaflet.heat for heat‑map rendering -->
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  <!-- PapaParse for robust CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Plotly for inline charts -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <!-- Tailwind (CDN) for modern dark UI -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>

  <style>
    /* full‑viewport map */
    html,body,#map{height:100%;margin:0;}

    /* Dark‑skinned Leaflet pop‑ups */
    .leaflet-popup-content-wrapper{background:#1f2937;color:#f3f4f6;border-radius:0.75rem;box-shadow:0 8px 16px rgba(0,0,0,.6);}  
    .leaflet-popup-tip{background:#1f2937;}
  </style>
</head>
<body class="bg-gray-900 text-gray-100">

<!-- MAP CONTAINER -->
<div id="map"></div>

<!-- UI: metric toggle -->
<div id="ui-panel" class="fixed top-4 right-4 bg-gray-800/80 backdrop-blur-sm shadow-xl rounded-2xl px-4 py-3 flex items-center gap-3 z-[1000] text-sm">
  <span class="font-medium">Metric:</span>
  <select id="metricSelect" class="bg-gray-700 border border-gray-600 rounded-md px-2 py-1 focus:outline-none">
    <option value="dose">Dose (µSv/h)</option>
    <option value="cps">Counts (cps)</option>
  </select>
</div>

<script>
/* ---------------------------------------------------------
 *  CONFIGURATION ———  NO BUILD STEP NEEDED
 * ---------------------------------------------------------
 * 1️⃣  Drop all your **.rctrk** (JSON) or **.csv** files in
 *     a folder named  /data   next to this index.html.
 * 2️⃣  OPTIONAL: create  data/track-index.json  with an
 *     array of filenames to load, e.g.:
 *       ["Track 11 Jul 2025 22-19-23.rctrk",
 *        "SummerTrip.csv"]
 *     If the manifest is not found, the list below is used.
 * --------------------------------------------------------- */
const FALLBACK_TRACK_FILES=[
  "data/Track 11 Jul 2025 22-19-23.rctrk"   // ⬅ customise / extend
];

/* ---------------------------------------------------------
 *  LEAFLET INITIALISATION
 * --------------------------------------------------------- */
const map=L.map('map',{
  worldCopyJump:true,
  attributionControl:false,
  zoomControl:false
}).setView([0,0],2);

// Dark OSM tiles (CartoDB “Dark Matter”)
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
  maxZoom:20,
  attribution:'&copy; OpenStreetMap & CartoDB'
}).addTo(map);

// Minimalist zoom bottom‑left
L.control.zoom({position:'bottomleft'}).addTo(map);

/* ---------------------------------------------------------
 *  GLOBAL STATE
 * --------------------------------------------------------- */
const tracks=[];  // {fname,pts:[]}
const heatLayer=L.heatLayer([],{
  radius:12,
  blur:22,
  maxZoom:18,
  gradient:{0:'#2c7bb6',0.35:'#abd9e9',0.6:'#ffffbf',0.8:'#fdae61',1:'#d7191c'}
}).addTo(map);

/* ---------------------------------------------------------
 *  HELPERS
 * --------------------------------------------------------- */
async function getTrackFileList(){
  try{
    const res=await fetch('data/track-index.json');
    if(!res.ok) throw new Error();
    return await res.json();
  }catch{ return FALLBACK_TRACK_FILES; }
}

function csvRowsToPts(rows){
  return rows.filter(r=>r.length>=4).map(r=>({
    lat:+r[0], lon:+r[1], dose:+r[2], cps:+r[3]
  })).filter(p=>!isNaN(p.lat)&&!isNaN(p.lon));
}

function parseTrackContent(text,fname){
  // Try JSON first (for .rctrk)
  try{
    const obj=JSON.parse(text);
    if(Array.isArray(obj.markers)){
      return obj.markers.map(m=>({
        lat:+m.lat,
        lon:+m.lon,
        dose:+(m.doseRate??m.dose_uSv_h??m.dose??0),
        cps:+(m.countRate??m.cps??0)
      })).filter(p=>!isNaN(p.lat)&&!isNaN(p.lon));
    }
  }catch(_){}

  // Fallback to CSV/TSV (auto‑delimiter via PapaParse)
  const parsed=Papa.parse(text.trim(),{dynamicTyping:true,skipEmptyLines:true});
  return csvRowsToPts(parsed.data);
}

/* ---------------------------------------------------------
 *  MAIN LOADER
 * --------------------------------------------------------- */
async function loadTracks(){
  const fileList=await getTrackFileList();
  const mapBounds=[];

  for(const fname of fileList){
    try{
      const res=await fetch(fname);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const txt=await res.text();
      const pts=parseTrackContent(txt,fname);
      if(!pts.length) continue;

      // stats
      const doses=pts.map(p=>p.dose);
      const cpses=pts.map(p=>p.cps);
      const avgDose=doses.reduce((a,b)=>a+b,0)/doses.length;
      const peakDose=Math.max(...doses);
      const avgCps=cpses.reduce((a,b)=>a+b,0)/cpses.length;
      const peakCps=Math.max(...cpses);

      // polyline — clickable
      const poly=L.polyline(pts.map(p=>[p.lat,p.lon]),{
        color:'#38bdf8',weight:3,opacity:0.8
      }).addTo(map);

      poly.on('click',()=>{
        const id=`plot-${btoa(fname).replace(/[^A-Za-z0-9]/g,'')}`;
        poly.bindPopup(`
          <div class='prose prose-sm dark:prose-invert'>
            <h3>${fname.split('/').pop()}</h3>
            <p><strong>Avg dose:</strong> ${avgDose.toFixed(3)} µSv/h<br>
               <strong>Peak dose:</strong> ${peakDose.toFixed(3)} µSv/h</p>
            <p><strong>Avg cps:</strong> ${avgCps.toFixed(1)} cps<br>
               <strong>Peak cps:</strong> ${peakCps.toFixed(1)} cps</p>
            <div id='${id}' class='mt-3' style='width:320px;height:220px;'></div>
          </div>`).openPopup();

        setTimeout(()=>{
          if(document.getElementById(id).children.length) return;
          const x=[...Array(pts.length).keys()];
          Plotly.newPlot(id,[
            {x,y:doses,name:'Dose (µSv/h)',type:'scatter',line:{width:2}},
            {x,y:cpses,name:'Counts (cps)',type:'scatter',yaxis:'y2',line:{width:2,dash:'dot'}}
          ],{
            margin:{l:40,r:40,t:10,b:30},
            paper_bgcolor:'#1f2937',plot_bgcolor:'#1f2937',
            font:{color:'#f3f4f6',size:10},
            legend:{orientation:'h'},
            xaxis:{title:'Fix #',showgrid:false},
            yaxis:{title:'µSv/h',showgrid:false},
            yaxis2:{overlaying:'y',side:'right',title:'cps'}
          },{displayModeBar:false});
        },200);
      });

      tracks.push({fname,pts});
      pts.forEach(p=>mapBounds.push([p.lat,p.lon]));
    }catch(err){
      console.warn('Could not load',fname,err);
    }
  }

  if(mapBounds.length) map.fitBounds(mapBounds,{padding:[50,50]});
  refreshHeatmap();
}

/* ---------------------------------------------------------
 *  HEATMAP
 * --------------------------------------------------------- */
function refreshHeatmap(){
  const metric=document.getElementById('metricSelect').value;
  const latlngs=[];
  tracks.forEach(t=>t.pts.forEach(p=>{
    const val=metric==='dose'?p.dose:p.cps;
    latlngs.push([p.lat,p.lon,val]);
  }));
  heatLayer.setLatLngs(latlngs);
}

document.getElementById('metricSelect').addEventListener('change',refreshHeatmap);

// kick‑off
loadTracks();
</script>
</body>
</html>
